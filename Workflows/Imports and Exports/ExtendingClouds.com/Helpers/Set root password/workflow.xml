<?xml version="1.0" encoding="ISO-8859-1" standalone="yes"?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item6" object-name="Workflow:name=generic" id="dd0b0666-06a7-4870-a2b2-511d2fcd29f6"  version="0.0.1" api-version="3.1.0" allowed-operations="fve" restartMode="1" resumeFromFailedMode="0" >
<display-name><![CDATA[Set root password]]></display-name>
<description><![CDATA[Runs an SSH command.]]></description>
<position x='160.0' y='10.0'/>
<input><param name='hostNameOrIP' type='string' >
<description><![CDATA[Hostname or IP address of the SSH host]]></description>
</param>
<param name='username' type='string' >
<description><![CDATA[Username]]></description>
</param>
<param name='password' type='SecureString' >
<description><![CDATA[Password]]></description>
</param>
<param name='cmd' type='string' >
<description><![CDATA[The SSH command to run]]></description>
</param>
</input><output><param name='result' type='number' >
<description><![CDATA[0 = OK, Negative = Error, Positive = Number of values returned, after error text]]></description>
</param>
<param name='errorText' type='string' >
<description><![CDATA[Error text, if any]]></description>
</param>
<param name='outputText' type='string' >
<description><![CDATA[Result of running the SSH command]]></description>
</param>
</output><attrib name='output' type='string' read-only='false' ><value encoded='n'><![CDATA[]]></value>
<description><![CDATA[Standard output]]></description>
</attrib>
<attrib name='error' type='string' read-only='false' ><value encoded='n'><![CDATA[]]></value>
<description><![CDATA[Error output]]></description>
</attrib>
<attrib name='defaultKeyPairPath' type='Path' read-only='false' ><value encoded='n'><![CDATA[../conf/vco_key]]></value>
<description><![CDATA[Default path to the key file]]></description>
</attrib>
<attrib name='exitCode' type='string' read-only='false' ><value encoded='n'><![CDATA[]]></value>
<description><![CDATA[Returns 0 if successful, and a negative value if there is a failure]]></description>
</attrib>
<attrib name='logText' type='string' read-only='false' ><value encoded='n'><![CDATA[]]></value>
<description><![CDATA[Log String]]></description>
</attrib>
<attrib name='passwordAuthentication' type='boolean' read-only='false' ><value encoded='n'><![CDATA[true]]></value>
<description><![CDATA[Sets authentication to password or key file]]></description>
</attrib>
<attrib name='path' type='Path' read-only='false' ><value encoded='n'><![CDATA[]]></value>
<description><![CDATA[Path to the private key]]></description>
</attrib>
<attrib name='passphrase' type='SecureString' read-only='false' ><value encoded='n'><![CDATA[]]></value>
<description><![CDATA[Private key pass-phrase]]></description>
</attrib>
<workflow-item name='item3' out-name='item2' type='condition' alt-out-name='item4' comparator='0' >
<display-name><![CDATA[ok?]]></display-name>
<script encoded='false'><![CDATA[//Generated by the system, cannot be edited
return (error == "null") ;]]></script>
<in-binding><bind name='error' type='string' export-name="error" ></bind>
</in-binding><condition name='error' type='string' comparator='0'></condition>
<position x='120.0' y='170.0'/>
</workflow-item>
<workflow-item name='item2' out-name='item5' content-mode='y' type='task' >
<display-name><![CDATA[System+Server log]]></display-name>
<script encoded='false'><![CDATA[//Auto-generated script
System.log(text + " - " + object);
Server.log(text, object);
]]></script>
<in-binding><bind name='text' type='String' export-name="cmd" ><description><![CDATA[The text to log]]></description>
</bind>
<bind name='object' type='string' export-name="logText" ><description><![CDATA[The text to log and additional info]]></description>
</bind>
</in-binding><out-binding></out-binding><description><![CDATA[Log the input text to the console and the server log with level 'log']]></description>
<position x='40.0' y='240.0'/>
</workflow-item>
<workflow-item name='item4' out-name='item5' content-mode='y' type='task' >
<display-name><![CDATA[System+Server error]]></display-name>
<script encoded='false'><![CDATA[//Auto-generated script
System.error(text + " - " + object);
Server.error(text, object);
]]></script>
<in-binding><bind name='text' type='String' export-name="cmd" ><description><![CDATA[The text to log]]></description>
</bind>
<bind name='object' type='string' export-name="logText" ><description><![CDATA[The text to log and additional info]]></description>
</bind>
</in-binding><out-binding></out-binding><description><![CDATA[Log the input text to the console and the server log with level 'error']]></description>
<position x='200.0' y='240.0'/>
</workflow-item>
<workflow-item name='item5' out-name='item8' type='task' >
<display-name><![CDATA[Assign]]></display-name>
<script encoded='false'><![CDATA[outputText = output;
errorText = error;
if(error == ""){
	result = 1;
} else {
	result = -1;
	throw "SSH execute command failed. " + error;
}
]]></script>
<in-binding><bind name='output' type='string' export-name="output" ></bind>
<bind name='error' type='string' export-name="error" ></bind>
</in-binding><out-binding><bind name='result' type='number' export-name="result" ></bind>
<bind name='outputText' type='string' export-name="outputText" ></bind>
<bind name='errorText' type='string' export-name="errorText" ></bind>
</out-binding><position x='120.0' y='280.0'/>
</workflow-item>
<workflow-item name='item6' out-name='item9' type='task' >
<display-name><![CDATA[Execute SSH Command]]></display-name>
<script encoded='false'><![CDATA[try{
	var session = new SSHSession(hostName,username);
	
	if(passwordAuthentication){
		System.log("Connecting with password");
	} else {
		if(path == null || path == ""){
			System.log("using default");
			path = defaultKeyPairPath;
		}
		System.log("Connecting with key pair ("+path+")");
		password = passphrase;
	}

	session.connectWithPasswordOrIdentity(passwordAuthentication,password,path);
	System.log("Connected!");
	
	System.log("Executing '"+cmd+"'");
	session.executeCommand(cmd,true) ;
	
	output = session.getOutput();
	error = session.getError();
	exitCode = session.exitCode;
	
	System.log("Output: '"+output+"'");
	System.log("Error: '"+error+"'");
	System.log("Exit code: '"+exitCode+"'");
	
	session.disconnect();
	
} catch (e) {
	throw "Unable to execute command " + e;
}	
]]></script>
<in-binding><bind name='username' type='string' export-name="username" ></bind>
<bind name='password' type='SecureString' export-name="password" ></bind>
<bind name='cmd' type='string' export-name="cmd" ></bind>
<bind name='passwordAuthentication' type='boolean' export-name="passwordAuthentication" ></bind>
<bind name='path' type='Path' export-name="path" ></bind>
<bind name='hostName' type='string' export-name="hostNameOrIP" ></bind>
<bind name='passphrase' type='SecureString' export-name="passphrase" ></bind>
<bind name='defaultKeyPairPath' type='Path' export-name="defaultKeyPairPath" ></bind>
</in-binding><out-binding><bind name='output' type='string' export-name="output" ></bind>
<bind name='error' type='string' export-name="error" ></bind>
<bind name='exitCode' type='string' export-name="exitCode" ></bind>
</out-binding><position x='120.0' y='60.0'/>
</workflow-item>
<workflow-item name='item8' type='end' end-mode='0' >
<position x='160.0' y='310.0'/>
</workflow-item>
<workflow-item name='item9' out-name='item3' type='task' >
<display-name><![CDATA[Prepare for log]]></display-name>
<script encoded='false'><![CDATA[logText = "output: " + output + "\n" + "error: " + error;
]]></script>
<in-binding><bind name='output' type='string' export-name="output" ></bind>
<bind name='error' type='string' export-name="error" ></bind>
</in-binding><out-binding><bind name='logText' type='string' export-name="logText" ></bind>
</out-binding><position x='120.0' y='120.0'/>
</workflow-item>
<presentation>
<p-step>
<title><![CDATA[Host]]></title>
<p-group>
<title><![CDATA[Host selection]]></title>
<desc><![CDATA[Select if you want ot choose host from a list or enter a name or IP address]]></desc>
<p-param name="hostNameOrIP"><desc><![CDATA[Host name or IP  of the SSH host]]></desc>
<p-qual kind="static" name="mandatory" type="boolean" ><![CDATA[true]]></p-qual></p-param>
</p-group>
<p-group>
<title><![CDATA[Command]]></title>
<desc><![CDATA[The command to execute]]></desc>
<p-param name="cmd"><desc><![CDATA[The SSH command to run]]></desc>
<p-qual name="defaultValue" type="string" ><![CDATA[uptime]]></p-qual></p-param>
</p-group>
<p-group>
<title><![CDATA[Authentication]]></title>
</p-group>
</p-step>
<p-step>
<title><![CDATA[Authentication]]></title>
<p-group>
<title><![CDATA[Host]]></title>
<desc><![CDATA[Enter connection info for host to execute the command on]]></desc>
<p-param name="username"><desc><![CDATA[Username]]></desc>
</p-param>
</p-group>
<p-group>
<title><![CDATA[Authentication]]></title>
<desc><![CDATA[If authentication method is password enter the password, otherwise enter the path for the key pair and passphrase for the private key]]></desc>
<p-param name="password"><desc><![CDATA[Password]]></desc>
<p-qual name="visible" ><![CDATA[passwordAuthentication/passwordAuthentication]]></p-qual></p-param>
</p-group>
</p-step>
</presentation></workflow>